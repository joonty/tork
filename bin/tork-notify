require 'tork/client'

Tork::Client::Receiver.new('tork-remote tork-engine') do |message|
  event, test_file, line_numbers, log_file = message

  # make notifications edge-triggered: pass => fail or vice versa.
  # we do not care about pass => pass or fail => fail transitions.
  icon = case event.to_sym
         when :fail_now_pass then 'dialog-error'
         when :pass_now_fail then 'dialog-information'
         end

  if icon
    title = [event.upcase, test_file].join(' ')

    statistics = File.readlines(log_file).grep(/^\d+ \w+,/).join.
      gsub(/\e\[\d+(;\d+)?m/, '') # strip ANSI SGR escape codes

    Thread.new do # run in background
      system 'notify-send', '-i', icon, title, statistics or
      system 'growlnotify', '-a', 'Xcode', '-m', statistics, title or
      system 'xmessage', '-timeout', '5', '-title', title, statistics
    end
  end
end
