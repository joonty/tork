#!/usr/bin/env ruby
=begin =======================================================================

# TORK-HERALD 1 2013-11-25 19.4.0

## NAME

tork-herald - reports modified files

## SYNOPSIS

`tork-herald` [*OPTION*]...

## DESCRIPTION

This program monitors the current working directory and all those below it
recursively.  When any files therein are modified, it prints their relative
paths in a single-line JSON array to stdout.

## OPTIONS

`-h`, `--help`
  Show this help manual.

## SEE ALSO

tork(1), tork-driver(1)

=end =========================================================================

$0 = File.basename(__FILE__) # for easier identification in ps(1) output

require 'binman'
BinMan.help

require 'json'
STDOUT.sync = true # flush puts() output immediately after writing

require 'pathname'
PWD = Pathname.new(Dir.pwd)

require 'listen'
Listen.to PWD do |modified, added, removed|
  files = (modified + added).uniq.map do |file|
    Pathname.new(file).relative_path_from(PWD)
  end
  puts JSON.dump(files) unless files.empty?
end.start
sleep
